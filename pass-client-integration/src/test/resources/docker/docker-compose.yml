version: '2'

services:

  fcrepo:
    image: oapass/fcrepo:4.7.5-2.0-SNAPSHOT
    container_name: fcrepo
    environment:
      FCREPO_HOST: "${FCREPO_HOST}"
      FCREPO_PORT: "${FCREPO_PORT}"
      FCREPO_JMS_PORT: "${FCREPO_JMS_PORT}"
      FCREPO_STOMP_PORT: "${FCREPO_STOMP_PORT}"
      COMPACTION_URI: "https://oa-pass.github.io/pass-data-model/src/main/resources/context-2.0.jsonld"
      COMPACTION_PRELOAD_URI_PASS_STATIC: "https://oa-pass.github.io/pass-data-model/src/main/resources/context-2.0.jsonld"
      COMPACTION_PRELOAD_FILE_PASS_STATIC: "${COMPACTION_PRELOAD_FILE_PASS_STATIC:-/usr/local/tomcat/lib/context-2.0.jsonld}"
      FCREPO_JMS_BASEURL: "http://${FCREPO_HOST}:${FCREPO_PORT}/fcrepo/rest"
      FCREPO_ACTIVEMQ_CONFIGURATION: "classpath:/activemq-queue.xml"
    ports: 
      - "${FCREPO_PORT}:${FCREPO_PORT}"
      - "${FCREPO_JMS_PORT}:${FCREPO_JMS_PORT}"
      - "${FCREPO_STOMP_PORT}:${FCREPO_STOMP_PORT}"
    volumes:
      - "mnt/:/mnt"

  indexer:
    image: oapass/indexer
    container_name: indexer
    environment:
      PI_FEDORA_USER: "fedoraAdmin"
      PI_FEDORA_PASS: "moo"
      PI_FEDORA_INTERNAL_BASE: "http://fcrepo:${FCREPO_PORT}/fcrepo/rest/"
      PI_ES_BASE: "http://elasticsearch:${ES_PORT}/"
      PI_ES_INDEX: "http://elasticsearch:${ES_PORT}/pass/"
      PI_FEDORA_JMS_BROKER: "tcp://fcrepo:${FCREPO_JMS_PORT}"
      PI_FEDORA_JMS_QUEUE: "fedora"
      PI_TYPE_PREFIX: "http://example.org/pass/"
      PI_LOG_LEVEL: "info"
    links:
      - fcrepo:localhost
      - elasticsearch
    volumes:
      - ./hosts:/etc/hosts

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch-oss:6.2.3
    container_name: elasticsearch
    environment:
      - ES_PORT="${ES_PORT}"
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - esdata:/usr/share/elasticsearch/data
    ports: 
      - "${ES_PORT}:${ES_PORT}"
      
volumes:
  esdata:
    driver: local
